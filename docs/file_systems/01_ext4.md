# Ext4

**Ext4** stands for Fourth Extended Filesystem, the fourth major iteration of the EXT family used in Linux. On a normal Linux system, Ext4 support is already installed by default.

```sh
mkfs.ext4 -V
grep ext4 /proc/filesystems
```

## Key features of Ext4

- Journaling: Keeps a log (journal) of changes before applying them, which helps avoid corruption after power loss.
- Large file & volume support: Files up to 16TB, volumes up to 1 exabyte.
- Extents: Stores large contiguous blocks more efficiently than older systems.
- Backward compatibility: Can mount Ext3 and Ext2 filesystems.
- Delayed allocation: Groups small writes into bigger chunks to improve performance.
- Checksums: In the journal to detect corruption.

Ext4 is default on most Linux distributions because it’s: Reliable, Well-supported, and Balanced between speed and safety.

## Usage

### Formatting a Disk or Partition with Ext4

If you have a raw disk or partition, you can format it:

```sh
sudo mkfs.ext4 /dev/sdb1
```

> Warning: This erases any existing data on /dev/sdb1.

### Mounting it

Once it’s formatted, you mount it to a directory so you can use it:

```sh
# list the disks
lsblk
# partition (optional)
sudo fdisk /dev/sdb
# mount
sudo mkdir /mnt/mydisk
sudo mount /dev/sdb1 /mnt/mydisk
```

Now `/mnt/mydisk` acts like a normal folder, but its contents are stored on that Ext4 filesystem.

## Virtual Disk
We’ll make a virtual disk image, format it as Ext4, and mount it.

```bash
# make a 2GB empty image file
dd if=/dev/zero of=ext4_test.img bs=1M count=2048

# format it as Ext4
mkfs.ext4 ext4_test.img

# make a mount point
mkdir /mnt/ext4test

# mount it using a loop device
sudo mount -o loop ext4_test.img /mnt/ext4test
```

> Now `/mnt/ext4test` is your sandbox Ext4 filesystem.

You can watch filesystem activity:

* **Journal activity**:

```bash
sudo iostat -x 1
```

* **Ext4 mount stats**:

```bash
sudo cat /proc/fs/ext4/$(mount | grep ext4test | awk '{print $1}' | cut -d'/' -f3)/mb_groups
```

* **Inode and block usage**:

```bash
df -h /mnt/ext4test
sudo tune2fs -l /dev/loop0 | grep -E "Block size|Inode size|Filesystem features"
```

* **Metadata changes**:

```bash
sudo debugfs /dev/loop0
# Then inside debugfs: stat /seq_test_file, stat /rand_test_file, etc.
```

When you’re done:

```bash
cd ~
sudo umount /mnt/ext4test
rm -rf /mnt/ext4test
```

Your original `ext4_test.img` will still have all results if you want to inspect it later.

```sh
rm ext4_test.img
```
